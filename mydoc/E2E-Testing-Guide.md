# E2E Testing Guide - Stories 1-4

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† Participium é¡¹ç›®çš„ç«¯åˆ°ç«¯ï¼ˆEnd-to-End, E2Eï¼‰æµ‹è¯•ï¼Œè¦†ç›– Story 1 åˆ° Story 4 çš„å®Œæ•´ç”¨æˆ·æµç¨‹ã€‚

---

## ğŸ¯ ä»€ä¹ˆæ˜¯ E2E æµ‹è¯•ï¼Ÿ

### E2E vs Integration vs Unit æµ‹è¯•

| æµ‹è¯•ç±»å‹ | èŒƒå›´ | ç›®çš„ | ç¤ºä¾‹ |
|---------|------|------|------|
| **Unit Test** | å•ä¸ªå‡½æ•°/æ–¹æ³• | éªŒè¯å•å…ƒé€»è¾‘ | æµ‹è¯•å¯†ç å“ˆå¸Œå‡½æ•° |
| **Integration Test** | å¤šä¸ªç»„ä»¶åä½œ | éªŒè¯ç»„ä»¶äº¤äº’ | æµ‹è¯• API ç«¯ç‚¹ |
| **E2E Test** | å®Œæ•´ç”¨æˆ·æµç¨‹ | éªŒè¯ç«¯åˆ°ç«¯åœºæ™¯ | ç”¨æˆ·æ³¨å†Œâ†’ç™»å½•â†’åˆ›å»ºæŠ¥å‘Š |

### E2E æµ‹è¯•çš„ç‰¹ç‚¹

- âœ… æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æ—…ç¨‹
- âœ… è·¨å¤šä¸ª API ç«¯ç‚¹
- âœ… æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º
- âœ… éªŒè¯æ•°æ®æŒä¹…åŒ–
- âœ… æ£€æŸ¥çŠ¶æ€è½¬æ¢

---

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
server/test/e2e/
â”œâ”€â”€ story1.e2e.test.ts    # Story 1: ç”¨æˆ·æ³¨å†Œå’Œè®¤è¯
â”œâ”€â”€ story2.e2e.test.ts    # Story 2: ç®¡ç†å‘˜ç®¡ç† Municipality ç”¨æˆ·
â”œâ”€â”€ story3.e2e.test.ts    # Story 3: Municipality ç”¨æˆ·è§’è‰²ç®¡ç†
â””â”€â”€ story4.e2e.test.ts    # Story 4: å…¬æ°‘æŠ¥å‘Šç³»ç»Ÿ
```

---

## ğŸ§ª Story 1 E2E æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`server/test/e2e/story1.e2e.test.ts`

### æµ‹è¯•åœºæ™¯

#### 1. å®Œæ•´ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ
```
æ³¨å†Œ â†’ ç™»å½• â†’ è·å–ä¼šè¯ â†’ ç™»å‡º â†’ éªŒè¯ç™»å‡º
```

**æµ‹è¯•æ­¥éª¤**:
1. ç”¨æˆ·æ³¨å†Œä¸ºæ–°å…¬æ°‘
2. ç”¨æˆ·ä½¿ç”¨å‡­æ®ç™»å½•
3. ç”¨æˆ·è®¿é—®ä¼šè¯ä¿¡æ¯
4. ç”¨æˆ·ç™»å‡º
5. éªŒè¯ä¼šè¯å·²æ¸…é™¤

#### 2. é”™è¯¯å¤„ç†åœºæ™¯
- é”™è¯¯å¯†ç ç™»å½•
- é‡å¤æ³¨å†Œ
- æœªæ³¨å†Œç”¨æˆ·ç™»å½•
- æœªç™»å½•çŠ¶æ€ç™»å‡º

#### 3. ä¼šè¯ç®¡ç†
- è·¨å¤šä¸ªè¯·æ±‚ç»´æŒä¼šè¯
- å¹¶å‘ä¼šè¯éš”ç¦»

#### 4. æ•°æ®éªŒè¯
- ç¼ºå¤±å­—æ®µéªŒè¯
- ç©ºå­—æ®µéªŒè¯
- å¯†ç åŠ å¯†éªŒè¯

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•å¥—ä»¶**: 4ä¸ª describe å—
- **æµ‹è¯•ç”¨ä¾‹**: 8ä¸ª it æµ‹è¯•
- **è¦†ç›–çš„ API**: POST /api/citizen/signup, POST /api/session, GET /api/session/current, DELETE /api/session/current

---

## ğŸ§ª Story 2 E2E æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`server/test/e2e/story2.e2e.test.ts`

### æµ‹è¯•åœºæ™¯

#### 1. å®Œæ•´ç®¡ç†å‘˜å·¥ä½œæµ
```
ç®¡ç†å‘˜ç™»å½• â†’ åˆ›å»º Municipality ç”¨æˆ· â†’ æŸ¥çœ‹åˆ—è¡¨ â†’ è·å–è¯¦æƒ… â†’ åˆ é™¤ç”¨æˆ·
```

**æµ‹è¯•æ­¥éª¤**:
1. ç®¡ç†å‘˜ç™»å½•
2. åˆ›å»º PUBLIC_RELATIONS ç”¨æˆ·
3. è·å–æ‰€æœ‰ municipality ç”¨æˆ·åˆ—è¡¨
4. è·å–ç‰¹å®šç”¨æˆ·è¯¦æƒ…
5. åˆ é™¤ç”¨æˆ·
6. éªŒè¯åˆ é™¤

#### 2. å¤šè§’è‰²ç®¡ç†
- åˆ›å»ºä¸åŒè§’è‰²çš„ç”¨æˆ·ï¼ˆPUBLIC_RELATIONS, TECHNICAL_OFFICEï¼‰
- éªŒè¯æ‰€æœ‰ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­
- æ‰¹é‡æ“ä½œæµ‹è¯•

#### 3. æƒé™æ§åˆ¶
- é˜»æ­¢éç®¡ç†å‘˜è®¿é—®
- è¦æ±‚è®¤è¯
- è§’è‰²éªŒè¯

#### 4. æ•°æ®éªŒè¯
- ç¼ºå¤±å­—æ®µéªŒè¯
- æ— æ•ˆè§’è‰²éªŒè¯
- é‡å¤é‚®ç®±éªŒè¯
- åˆ é™¤ä¸å­˜åœ¨ç”¨æˆ·çš„å¤„ç†

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•å¥—ä»¶**: 4ä¸ª describe å—
- **æµ‹è¯•ç”¨ä¾‹**: 10ä¸ª it æµ‹è¯•
- **è¦†ç›–çš„ API**: POST /api/admin/municipality-users, GET /api/admin/municipality-users, GET /api/admin/municipality-users/:userId, DELETE /api/admin/municipality-users/:userId, GET /api/admin/roles

---

## ğŸ§ª Story 3 E2E æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`server/test/e2e/story3.e2e.test.ts`

### æµ‹è¯•åœºæ™¯

#### 1. è·¨è§’è‰²ç®¡ç†
```
åˆ›å»ºæ‰€æœ‰ä¸‰ç§ Municipality è§’è‰² â†’ éªŒè¯ â†’ æ£€ç´¢ â†’ åˆ é™¤
```

**è§’è‰²ç±»å‹**:
- ADMINISTRATOR
- PUBLIC_RELATIONS
- TECHNICAL_OFFICE

#### 2. åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- éªŒè¯ ADMINISTRATOR å¯ä»¥è®¿é—®ç®¡ç†ç«¯ç‚¹
- éªŒè¯ PUBLIC_RELATIONS ä¸èƒ½è®¿é—®ç®¡ç†ç«¯ç‚¹
- éªŒè¯ TECHNICAL_OFFICE ä¸èƒ½è®¿é—®ç®¡ç†ç«¯ç‚¹
- éªŒè¯ CITIZEN ä¸èƒ½è®¿é—®ç®¡ç†ç«¯ç‚¹

#### 3. è§’è‰²éªŒè¯
- æ¥å—æœ‰æ•ˆçš„ municipality è§’è‰²
- æ‹’ç» CITIZEN è§’è‰²ç”¨äº municipality ç”¨æˆ·
- æ‹’ç»å®Œå…¨æ— æ•ˆçš„è§’è‰²

#### 4. è§’è‰²æŒä¹…åŒ–
- éªŒè¯è§’è‰²æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- éªŒè¯è§’è‰²æ­£ç¡®æ£€ç´¢
- éªŒè¯è§’è‰²åœ¨åˆ—è¡¨ä¸­æ­£ç¡®æ˜¾ç¤º

#### 5. å¹¶å‘æ“ä½œ
- åŒæ—¶åˆ›å»ºå¤šä¸ªä¸åŒè§’è‰²çš„ç”¨æˆ·
- éªŒè¯å¹¶å‘æ“ä½œçš„æ•°æ®å®Œæ•´æ€§

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•å¥—ä»¶**: 6ä¸ª describe å—
- **æµ‹è¯•ç”¨ä¾‹**: 10ä¸ª it æµ‹è¯•
- **è¦†ç›–çš„è§’è‰²**: ADMINISTRATOR, PUBLIC_RELATIONS, TECHNICAL_OFFICE, CITIZEN

---

## ğŸ§ª Story 4 E2E æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`server/test/e2e/story4.e2e.test.ts`

### æµ‹è¯•åœºæ™¯

#### 1. å®Œæ•´æŠ¥å‘Šç”Ÿå‘½å‘¨æœŸ
```
å…¬æ°‘æ³¨å†Œ â†’ ç™»å½• â†’ åˆ›å»ºæŠ¥å‘Šï¼ˆå¸¦ç…§ç‰‡å’Œä½ç½®ï¼‰â†’ æŸ¥çœ‹æŠ¥å‘Š â†’ éªŒè¯çŠ¶æ€
```

**æµ‹è¯•æ­¥éª¤**:
1. å…¬æ°‘æ³¨å†Œ
2. å…¬æ°‘ç™»å½•
3. åˆ›å»ºæŠ¥å‘Šï¼ˆåŒ…å«ç…§ç‰‡å’Œ GPS åæ ‡ï¼‰
4. éªŒè¯æŠ¥å‘Šå¤„äºå¾…å®¡æ‰¹çŠ¶æ€
5. éªŒè¯å¾…å®¡æ‰¹æŠ¥å‘Šä¸åœ¨å…¬å¼€åˆ—è¡¨ä¸­

#### 2. å¤šæŠ¥å‘Šåœºæ™¯
- åŒä¸€å…¬æ°‘åˆ›å»ºå¤šä¸ªæŠ¥å‘Š
- åŒ¿åæŠ¥å‘Šæäº¤
- ä¸åŒç±»åˆ«çš„æŠ¥å‘Š

#### 3. æŠ¥å‘Šç±»åˆ«
æµ‹è¯•æ‰€æœ‰ 9 ç§æŠ¥å‘Šç±»åˆ«:
- WATER_SUPPLY_DRINKING_WATER (ä¾›æ°´å’Œé¥®ç”¨æ°´)
- ARCHITECTURAL_BARRIERS (å»ºç­‘éšœç¢)
- SEWER_SYSTEM (ä¸‹æ°´é“ç³»ç»Ÿ)
- PUBLIC_LIGHTING (å…¬å…±ç…§æ˜)
- WASTE (åƒåœ¾)
- ROAD_SIGNS_TRAFFIC_LIGHTS (é“è·¯æ ‡å¿—å’Œäº¤é€šç¯)
- ROADS_URBAN_FURNISHINGS (é“è·¯å’ŒåŸå¸‚è®¾æ–½)
- PUBLIC_GREEN_AREAS_PLAYGROUNDS (å…¬å…±ç»¿åœ°å’Œæ¸¸ä¹åœº)
- OTHER (å…¶ä»–)

#### 4. ä½ç½®æ•°æ®
- æœ‰æ•ˆ GPS åæ ‡ï¼ˆåŒ…æ‹¬è¾¹ç•Œæƒ…å†µï¼‰
- é›¶åæ ‡ï¼ˆ0, 0ï¼‰
- è´Ÿåæ ‡
- ç¼ºå¤±ä½ç½®æ•°æ®çš„å¤„ç†

#### 5. ç…§ç‰‡è¦æ±‚
- å•å¼ ç…§ç‰‡
- å¤šå¼ ç…§ç‰‡
- æ— ç…§ç‰‡æ—¶æ‹’ç»

#### 6. è®¤è¯è¦æ±‚
- è¦æ±‚ç™»å½•æ‰èƒ½åˆ›å»ºæŠ¥å‘Š
- è¦æ±‚ç™»å½•æ‰èƒ½æŸ¥çœ‹æŠ¥å‘Š

#### 7. æ•°æ®éªŒè¯
- ç¼ºå¤±æ ‡é¢˜
- ç¼ºå¤±æè¿°
- ç¼ºå¤±ç±»åˆ«
- ç¼ºå¤±ä½ç½®
- ç¼ºå¤±ç…§ç‰‡

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•å¥—ä»¶**: 8ä¸ª describe å—
- **æµ‹è¯•ç”¨ä¾‹**: 20ä¸ª it æµ‹è¯•
- **è¦†ç›–çš„ API**: POST /api/reports, GET /api/reports
- **æµ‹è¯•çš„ç±»åˆ«**: 9ç§æŠ¥å‘Šç±»åˆ«

---

## ğŸš€ è¿è¡Œ E2E æµ‹è¯•

### è¿è¡Œæ‰€æœ‰ E2E æµ‹è¯•

```bash
cd server
npm test -- test/e2e
```

### è¿è¡Œç‰¹å®š Story çš„æµ‹è¯•

```bash
# Story 1
npm test -- test/e2e/story1.e2e.test.ts

# Story 2
npm test -- test/e2e/story2.e2e.test.ts

# Story 3
npm test -- test/e2e/story3.e2e.test.ts

# Story 4
npm test -- test/e2e/story4.e2e.test.ts
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```bash
# è¿è¡ŒåŒ…å«ç‰¹å®šæè¿°çš„æµ‹è¯•
npm test -- test/e2e/story1.e2e.test.ts -t "complete the full user authentication lifecycle"
```

### æŸ¥çœ‹è¯¦ç»†è¾“å‡º

```bash
npm test -- test/e2e --verbose
```

---

## ğŸ“Š E2E æµ‹è¯•ç»Ÿè®¡æ€»è§ˆ

| Story | æµ‹è¯•æ–‡ä»¶ | Describe å— | æµ‹è¯•ç”¨ä¾‹ | è¦†ç›–åŠŸèƒ½ |
|-------|---------|------------|---------|---------|
| Story 1 | story1.e2e.test.ts | 4 | 8 | ç”¨æˆ·æ³¨å†Œå’Œè®¤è¯ |
| Story 2 | story2.e2e.test.ts | 4 | 10 | ç®¡ç†å‘˜ç®¡ç† Municipality ç”¨æˆ· |
| Story 3 | story3.e2e.test.ts | 6 | 10 | Municipality ç”¨æˆ·è§’è‰²ç®¡ç† |
| Story 4 | story4.e2e.test.ts | 8 | 20 | å…¬æ°‘æŠ¥å‘Šç³»ç»Ÿ |
| **æ€»è®¡** | **4 ä¸ªæ–‡ä»¶** | **22 ä¸ª** | **48 ä¸ª** | **å®Œæ•´ç”¨æˆ·æµç¨‹** |

---

## âœ… E2E æµ‹è¯•è¦†ç›–çš„ç”¨æˆ·æ—…ç¨‹

### Story 1: å…¬æ°‘ç”¨æˆ·
```
1. æ³¨å†Œè´¦æˆ·
2. ç™»å½•ç³»ç»Ÿ
3. æŸ¥çœ‹ä¼šè¯ä¿¡æ¯
4. æ‰§è¡Œæ“ä½œ
5. ç™»å‡ºç³»ç»Ÿ
```

### Story 2: ç®¡ç†å‘˜
```
1. ç®¡ç†å‘˜ç™»å½•
2. åˆ›å»º municipality ç”¨æˆ·
3. æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
4. è·å–ç”¨æˆ·è¯¦æƒ…
5. åˆ é™¤ç”¨æˆ·
```

### Story 3: è§’è‰²ç®¡ç†
```
1. åˆ›å»ºä¸åŒè§’è‰²çš„ç”¨æˆ·
2. éªŒè¯è§’è‰²æƒé™
3. æµ‹è¯•è®¿é—®æ§åˆ¶
4. éªŒè¯è§’è‰²æŒä¹…åŒ–
```

### Story 4: æŠ¥å‘Šç³»ç»Ÿ
```
1. å…¬æ°‘ç™»å½•
2. åˆ›å»ºæŠ¥å‘Šï¼ˆå«ç…§ç‰‡å’Œä½ç½®ï¼‰
3. æäº¤æŠ¥å‘Š
4. æŸ¥çœ‹æŠ¥å‘ŠçŠ¶æ€
5. éªŒè¯å®¡æ‰¹æµç¨‹
```

---

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•éš”ç¦»
```typescript
beforeEach(async () => {
  await cleanDatabase(); // æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®åº“
});

afterAll(async () => {
  await disconnectDatabase(); // æ‰€æœ‰æµ‹è¯•åæ–­å¼€è¿æ¥
});
```

### 2. ä½¿ç”¨ Agent ç»´æŒä¼šè¯
```typescript
const agent = request.agent(app);
await agent.post('/api/session').send(credentials);
// agent ä¼šè‡ªåŠ¨ä¿æŒ cookie/session
await agent.get('/api/reports'); // ä½¿ç”¨åŒä¸€ä¼šè¯
```

### 3. æ·»åŠ å»¶è¿Ÿç¡®ä¿æ•°æ®å†™å…¥
```typescript
await new Promise(resolve => setTimeout(resolve, 300));
```

### 4. æ¸…æ™°çš„æ—¥å¿—è¾“å‡º
```typescript
console.log('Step 1: Creating user...');
console.log('âœ“ User created successfully');
```

### 5. å®Œæ•´çš„æ–­è¨€
```typescript
expect(response.status).toBe(201);
expect(response.body).toHaveProperty('id');
expect(response.body.email).toBe(expectedEmail);
```

---

## ğŸ” è°ƒè¯• E2E æµ‹è¯•

### æŸ¥çœ‹è¯¦ç»†é”™è¯¯
```bash
npm test -- test/e2e --verbose --detectOpenHandles
```

### è¿è¡Œå•ä¸ªæµ‹è¯•
```bash
npm test -- test/e2e/story1.e2e.test.ts -t "should complete the full"
```

### æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
åœ¨æµ‹è¯•ä¸­æ·»åŠ :
```typescript
const users = await prisma.user.findMany();
console.log('Current users:', users);
```

---

## ğŸ“ ç»´æŠ¤ E2E æµ‹è¯•

### ä½•æ—¶æ›´æ–° E2E æµ‹è¯•

1. **API ç«¯ç‚¹å˜æ›´** - æ›´æ–°ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹
2. **æ–°å¢åŠŸèƒ½** - æ·»åŠ æ–°çš„ E2E åœºæ™¯
3. **ä¸šåŠ¡æµç¨‹å˜æ›´** - æ›´æ–°å®Œæ•´çš„ç”¨æˆ·æ—…ç¨‹
4. **Bug ä¿®å¤** - æ·»åŠ å›å½’æµ‹è¯•

### E2E æµ‹è¯•çš„ä»·å€¼

- âœ… æ•è·é›†æˆé—®é¢˜
- âœ… éªŒè¯å®Œæ•´åŠŸèƒ½
- âœ… é˜²æ­¢å›å½’
- âœ… æ–‡æ¡£åŒ–ç”¨æˆ·æµç¨‹
- âœ… å¢å¼ºä¿¡å¿ƒ

---

## ğŸ‰ æ€»ç»“

E2E æµ‹è¯•è¦†ç›–äº† Participium é¡¹ç›®çš„æ ¸å¿ƒç”¨æˆ·æ—…ç¨‹ï¼š

1. **Story 1** - ç”¨æˆ·å¯ä»¥æ³¨å†Œã€ç™»å½•ã€ç®¡ç†ä¼šè¯
2. **Story 2** - ç®¡ç†å‘˜å¯ä»¥ç®¡ç† municipality ç”¨æˆ·
3. **Story 3** - æ”¯æŒå¤šè§’è‰² municipality ç”¨æˆ·ç®¡ç†
4. **Story 4** - å…¬æ°‘å¯ä»¥åˆ›å»ºå’ŒæŸ¥çœ‹æŠ¥å‘Š

é€šè¿‡è¿™ 48 ä¸ª E2E æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ç¡®ä¿äº†ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ç«¯åˆ°ç«¯æ­£å¸¸å·¥ä½œã€‚

---

**åˆ›å»ºæ—¥æœŸ**: 2025-11-13  
**æµ‹è¯•ç‰ˆæœ¬**: Stories 1-4 Complete  
**çŠ¶æ€**: âœ… å®Œæˆ

